<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Pagos - StartEducation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #FF6B35;
            --secondary-color: #004E89;
        }

        body {
            background: #f8f9fa;
            font-family: 'Inter', sans-serif;
        }

        .page-header {
            background: linear-gradient(135deg, #16a085, #27ae60);
            color: white;
            padding: 40px 0;
            margin-bottom: 40px;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color), #F7931E);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 1.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .payment-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .payment-card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .payment-id {
            font-weight: 700;
            color: var(--secondary-color);
            font-size: 1.1rem;
        }

        .status-badge {
            padding: 6px 15px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .status-exitoso {
            background: #d4edda;
            color: #155724;
        }

        .status-fallido {
            background: #f8d7da;
            color: #721c24;
        }

        .status-reembolsado {
            background: #fff3cd;
            color: #856404;
        }

        .payment-amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .payment-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }

        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .btn-download {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .btn-download:hover {
            background: #003366;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-state i {
            font-size: 6rem;
            color: #dee2e6;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="page-header">
        <div class="container">
            <h1><i class="fas fa-file-invoice-dollar"></i> Historial de Pagos</h1>
            <p class="mb-0">Registro completo de tus transacciones</p>
        </div>
    </div>

    <div class="container">
        <!-- Stats Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-value">${{totalGastado}}</div>
                <div class="stat-label">Total Gastado</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-receipt"></i>
                </div>
                <div class="stat-value">{{totalPagos}}</div>
                <div class="stat-label">Total de Pagos</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-value">{{pagosExitosos}}</div>
                <div class="stat-label">Pagos Exitosos</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-calendar"></i>
                </div>
                <div class="stat-value">{{mesActual}}</div>
                <div class="stat-label">Este Mes</div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filter-section">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <label class="form-label">Estado</label>
                    <select class="form-select" id="filtroEstatus" onchange="filtrarPagos()">
                        <option value="">Todos</option>
                        <option value="exitoso">Exitosos</option>
                        <option value="fallido">Fallidos</option>
                        <option value="reembolsado">Reembolsados</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tipo</label>
                    <select class="form-select" id="filtroTipo" onchange="filtrarPagos()">
                        <option value="">Todos</option>
                        <option value="curso">Compras de Cursos</option>
                        <option value="suscripcion">Suscripciones</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Fecha Desde</label>
                    <input type="date" class="form-control" id="fechaDesde" onchange="filtrarPagos()">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Fecha Hasta</label>
                    <input type="date" class="form-control" id="fechaHasta" onchange="filtrarPagos()">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12 text-end">
                    <button class="btn btn-outline-primary" onclick="exportarPDF()">
                        <i class="fas fa-file-pdf"></i> Exportar PDF
                    </button>
                    <button class="btn btn-outline-success" onclick="exportarExcel()">
                        <i class="fas fa-file-excel"></i> Exportar Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Payment List -->
        {{#if pagos.length}}
            <div id="pagosContainer">
                {{#each pagos}}
                <div class="payment-card" data-estatus="{{estatus}}" data-tipo="{{tipo}}">
                    <div class="payment-header">
                        <div>
                            <div class="payment-id">
                                <i class="fas fa-hashtag"></i> Pago #{{id_pago}}
                            </div>
                            <small class="text-muted">{{formatDate fecha_pago}}</small>
                        </div>
                        <div>
                            <span class="status-badge status-{{estatus}}">
                                {{#if (eq estatus 'exitoso')}}
                                    <i class="fas fa-check-circle"></i> Exitoso
                                {{else if (eq estatus 'fallido')}}
                                    <i class="fas fa-times-circle"></i> Fallido
                                {{else}}
                                    <i class="fas fa-undo"></i> Reembolsado
                                {{/if}}
                            </span>
                        </div>
                    </div>

                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="payment-details">
                                <div class="detail-row">
                                    <span><i class="fas fa-tag"></i> Tipo:</span>
                                    <strong>
                                        {{#if id_suscripcion}}
                                            Suscripción - {{suscripcion_nombre}}
                                        {{else}}
                                            Compra - {{curso_titulo}}
                                        {{/if}}
                                    </strong>
                                </div>
                                {{#if metodo_pago}}
                                <div class="detail-row">
                                    <span><i class="fas fa-credit-card"></i> Método de pago:</span>
                                    <strong>{{metodo_pago}}</strong>
                                </div>
                                {{/if}}
                                {{#if descripcion}}
                                <div class="detail-row">
                                    <span><i class="fas fa-info-circle"></i> Descripción:</span>
                                    <span>{{descripcion}}</span>
                                </div>
                                {{/if}}
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="payment-amount">${{monto}}</div>
                            <button class="btn btn-download mt-2" onclick="descargarRecibo({{id_pago}})">
                                <i class="fas fa-download"></i> Descargar Recibo
                            </button>
                        </div>
                    </div>
                </div>
                {{/each}}
            </div>
        {{else}}
            <div class="empty-state">
                <i class="fas fa-file-invoice"></i>
                <h3>No hay pagos registrados</h3>
                <p class="text-muted">Tus transacciones aparecerán aquí</p>
                <a href="/membresias" class="btn btn-primary btn-lg mt-3">
                    <i class="fas fa-crown"></i> Ver Planes de Membresía
                </a>
            </div>
        {{/if}}

        <div class="text-center mt-4">
            <a href="/dashboard" class="btn btn-light btn-lg">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function filtrarPagos() {
            const estatus = document.getElementById('filtroEstatus').value;
            const tipo = document.getElementById('filtroTipo').value;
            const fechaDesde = document.getElementById('fechaDesde').value;
            const fechaHasta = document.getElementById('fechaHasta').value;

            const cards = document.querySelectorAll('.payment-card');
            cards.forEach(card => {
                const matchEstatus = !estatus || card.dataset.estatus === estatus;
                const matchTipo = !tipo || card.dataset.tipo === tipo;
                
                if (matchEstatus && matchTipo) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function descargarRecibo(idPago) {
            window.open(`/historial-pagos/${idPago}/recibo`, '_blank');
        }

        function exportarPDF() {
            window.location.href = '/historial-pagos/exportar/pdf';
        }

        function exportarExcel() {
            window.location.href = '/historial-pagos/exportar/excel';
        }
    </script>
</body>
</html>