<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}} - StartEducation Admin</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Admin Styles -->
    <link rel="stylesheet" href="/stylesheets/admin-base.css">
    
    <style>
        .video-preview {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .video-preview iframe {
            max-width: 100%;
            height: 300px;
            border-radius: 8px;
        }
        
        .video-info {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .video-info h6 {
            color: #6c757d;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .video-info p {
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }
        
        .btn-save {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            color: white;
        }
        
        .btn-cancel {
            background: #6c757d;
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .btn-cancel:hover {
            background: #5a6268;
            color: white;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/dashboard">
                <i class="bi bi-mortarboard-fill me-2"></i>StartEducation Admin
            </a>
            
            <div class="d-flex align-items-center">
                <span class="text-light me-3">
                    <i class="bi bi-person-circle me-1"></i>{{userName}} ({{userRole}})
                </span>
                <a href="/auth/logout" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-box-arrow-right me-1"></i>Cerrar Sesión
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-8">
                <!-- Formulario de Edición -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="bi bi-pencil-square text-warning me-2"></i>Editar Video
                        </h4>
                        <a href="/admin/videos" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-left me-1"></i>Volver a Videos
                        </a>
                    </div>
                    <div class="card-body">
                        <form id="editVideoForm">
                            <!-- Título -->
                            <div class="mb-3">
                                <label for="titulo" class="form-label fw-bold">Título del Video *</label>
                                <input type="text" class="form-control" id="titulo" name="titulo" 
                                       value="{{video.titulo}}" required>
                            </div>

                            <!-- Descripción -->
                            <div class="mb-3">
                                <label for="descripcion" class="form-label fw-bold">Descripción</label>
                                <textarea class="form-control" id="descripcion" name="descripcion" 
                                          rows="4" placeholder="Descripción del video...">{{video.descripcion}}</textarea>
                            </div>

                            <!-- Módulo -->
                            <div class="mb-3">
                                <label for="id_modulo" class="form-label fw-bold">Módulo *</label>
                                <select class="form-select" id="id_modulo" name="id_modulo" required>
                                    <option value="">Seleccionar módulo...</option>
                                    {{#each modulos}}
                                    <option value="{{id_modulo}}" {{#if (eq id_modulo ../video.id_modulo)}}selected{{/if}}>
                                        {{display_name}}
                                    </option>
                                    {{/each}}
                                </select>
                            </div>

                            <!-- Estado -->
                            <div class="mb-3">
                                <label for="estatus" class="form-label fw-bold">Estado</label>
                                <select class="form-select" id="estatus" name="estatus">
                                    <option value="borrador" {{#if (eq video.estatus 'borrador')}}selected{{/if}}>Borrador</option>
                                    <option value="activo" {{#if (eq video.estatus 'activo')}}selected{{/if}}>Activo</option>
                                    <option value="archivado" {{#if (eq video.estatus 'archivado')}}selected{{/if}}>Archivado</option>
                                </select>
                            </div>

                            <!-- Botones -->
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-save">
                                    <i class="bi bi-check-lg me-1"></i>Guardar Cambios
                                </button>
                                <a href="/admin/videos" class="btn-cancel">
                                    <i class="bi bi-x-lg me-1"></i>Cancelar
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <!-- Información del Video -->
                <div class="video-info">
                    <h6>Información del Video</h6>
                    <p><strong>ID:</strong> {{video.id_video}}</p>
                    <p><strong>Proveedor:</strong> 
                        {{#if (eq video.video_provider 'bunny')}}
                            <span class="badge bg-info">Bunny.net</span>
                        {{else}}
                            <span class="badge bg-secondary">Vimeo (Legacy)</span>
                        {{/if}}
                    </p>
                    {{#if video.bunny_video_id}}
                    <p><strong>Bunny ID:</strong> <code>{{video.bunny_video_id}}</code></p>
                    {{/if}}
                    {{#if video.duracion_segundos}}
                    <p><strong>Duración:</strong> {{formatDuration video.duracion_segundos}}</p>
                    {{/if}}
                    <p><strong>Módulo Actual:</strong> {{video.modulo_titulo}}</p>
                    <p><strong>Curso:</strong> {{video.curso_titulo}}</p>
                </div>

                <!-- Vista Previa del Video -->
                {{#if video.bunny_video_id}}
                <div class="video-preview">
                    <h6 class="mb-3">Vista Previa</h6>
                    <iframe 
                        src="https://iframe.mediadelivery.net/embed/{{video.bunny_library_id}}/{{video.bunny_video_id}}?autoplay=false&controls=true&responsive=true" 
                        frameborder="0" 
                        allow="autoplay; fullscreen; picture-in-picture; encrypted-media" 
                        allowfullscreen
                        title="{{video.titulo}}">
                    </iframe>
                </div>
                {{else if video.url_vimeo}}
                <div class="video-preview">
                    <h6 class="mb-3">Vista Previa (Vimeo Legacy)</h6>
                    <p class="text-muted">Video de Vimeo - ID extraído de URL</p>
                </div>
                {{else}}
                <div class="video-preview">
                    <i class="bi bi-camera-video text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">No hay video disponible</p>
                </div>
                {{/if}}
            </div>
        </div>
    </div>

    <!-- Bootstrap 5.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.getElementById('editVideoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            try {
                // Mostrar loading
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Guardando...';
                submitBtn.disabled = true;
                
                const response = await fetch(`/admin/videos/{{video.id_video}}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Mostrar éxito
                    submitBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i>¡Guardado!';
                    submitBtn.classList.remove('btn-save');
                    submitBtn.classList.add('btn-success');
                    
                    // Redirigir después de un momento
                    setTimeout(() => {
                        window.location.href = '/admin/videos';
                    }, 1500);
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }
                
            } catch (error) {
                console.error('Error:', error);
                
                // Mostrar error
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Error';
                submitBtn.classList.remove('btn-save');
                submitBtn.classList.add('btn-danger');
                
                alert('Error al actualizar el video: ' + error.message);
                
                // Restaurar botón después de un momento
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.classList.remove('btn-danger');
                    submitBtn.classList.add('btn-save');
                    submitBtn.disabled = false;
                }, 3000);
            }
        });
    </script>
</body>
</html>